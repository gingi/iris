<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">define([&quot;iris&quot;], function (Iris) {
    var widget = {};
    widget.about = {
        title: &quot;Manhattan Plot&quot;,
        name: &quot;manhattan&quot;,
        author: &quot;Andrew Olson&quot;
    };

    var ctx;
    var ctxi;
    var canvasi;
    var tool = {};
    tool.started = false;
    var global_min = 0;
    var globalMax = 0;
    var chrLengths = [];
    var totalLen = 0;
    var sc = 2;
    var radius = 2;
    var circles = true;
    var XGUTTER = 10;
    var colorByDensity = true;
    var chrRange = [];
    var scoreA;
    var scoreB;
    var mincolor = [];
    var maxcolor = [];

    var goDiv1;
    var goDiv2;
    var study;
    var tooSmall = 0.03;
    var GOWidth;

    widget.display = function (element, args) {
        args = (args || {});
        var myDiv = $(element);
        myDiv.append('&lt;div id=&quot;' + element.id + '_man&quot;&gt;');
        var div = $(document.getElementById(element.id + &quot;_man&quot;));
        var canvasHeight = Math.max(div.height(), $(&quot;body&quot;).height());
        var canvasWidth = Math.max(div.parent().width(), $(&quot;body&quot;).width());
        GOWidth = Math.min(Math.floor(canvasWidth/2), 300);
        div.append('&lt;canvas id=&quot;' + element.id + '_canvas&quot;, width=' + canvasWidth + ' height=' + canvasHeight + ' style=&quot;position:absolute;left:0;top:0;z-index:0;&quot;&gt;&lt;/canvas&gt;');
        div.append('&lt;canvas id=&quot;' + element.id + '_canvasi&quot;, width=' + canvasWidth + ' height=' + canvasHeight + ' style=&quot;position:absolute;left:0;top:0;z-index:1;&quot;&gt;&lt;/canvas&gt;');
        div.height(canvasHeight);

        // myDiv.append('&lt;div id=&quot;' + element.id + '_goTable&quot; style=&quot;position:absolute;left:0px;top:' + canvasHeight + 'px;z-index:0;&quot;&gt;');
        // myDiv.append('&lt;div id=&quot;' + element.id + '_goPie&quot; style=&quot;position:absolute;left:' + GOWidth + 'px;top:' + canvasHeight + 'px;z-index:0;&quot;&gt;');
        myDiv.append('&lt;div id=&quot;' + element.id + '_goTable&quot;&gt;');
        myDiv.append('&lt;div id=&quot;' + element.id + '_goPie&quot;&gt;');
        goDiv1 = document.getElementById(element.id + &quot;_goPie&quot;);
        goDiv2 = document.getElementById(element.id + &quot;_goTable&quot;);
        
        // div.parent.height = canvasHeight;
        // div.parent.width = canvasWidth;

        var canvas = document.getElementById(element.id + &quot;_canvas&quot;);
        canvasi = document.getElementById(element.id + &quot;_canvasi&quot;);
        ctx = canvas.getContext('2d');
        ctxi = canvasi.getContext('2d');

        study = (args.hasOwnProperty('study')) ? args['study'] : 3396;
        var species = (args.hasOwnProperty('species')) ? args['species'] : 'at';


        // fetch the list of chromosomes and their lengths
        totalLen = 0;
        $.getJSON(&quot;/species/&quot; + species + &quot;/chromosomes&quot;, function (json) {
            for (var chr in json) {
                chrLengths[chr] = json[chr];
                totalLen += parseInt(json[chr]);
            }
            // fetch the max score for this study
            $.getJSON(&quot;/gwas/&quot; + study + &quot;/maxscore&quot;, function (json) {
                globalMax = Math.ceil(json[0][0]);
                drawManhattan(study);
            });
        });
    };

    /*
    function renderGO(limits) {
        var url = &quot;/gwas/&quot; + study + &quot;/GO&quot;;
        if (limits) {
            url += &quot;?w=&quot; + limits;
        }
        $.getJSON(url, function (json) {
            Iris.Renderer.table.render( { target: goDiv2, width: GOWidth, height: GOWidth, data: {data: json, header: [&quot;GOSlim term&quot;, &quot;Genes&quot;]}});
            // combine tiny slices of the pie into an &quot;Other&quot; category
            var sum=0;
            for( var i=0; i&lt;json.length; i++) {
                sum += json[i][1];
            }
            var cutoff = sum*tooSmall;
            var pieData = [];
            var other=0;
            for (var i=0; i&lt;json.length; i++) {
                if (json[i][1] &lt; cutoff) {
                    other += json[i][1];
                } else {
                    pieData.push(json[i]);
                }
            }
            if (other &gt; 0) {
                pieData.push([&quot;Others&quot;, other]);
            }
            Iris.Renderer.piechart.render( {target: goDiv1, data: pieData, width: GOWidth, height: GOWidth, radius: Math.floor(GOWidth/2)})
        });
    }
    */
    
    function drawManhattan(study, cvs) {
        // get the canvas
        ctx.strokeStyle = &quot;black&quot;;

        ctxi.strokeStyle = &quot;red&quot;;
        ctxi.fillStyle = &quot;rgba(255,0,0,0.3)&quot;;

        // add event listeners
        canvasi.addEventListener('mousedown', startDragEvent(), false);
        canvasi.addEventListener('mousemove', moveDragEvent(), false);
        canvasi.addEventListener('mouseup', releaseDragEvent(), false);

        var offset = XGUTTER;
        var ysize = ctx.canvas.height;
        for (var chr in chrLengths) {
            var xsize = (ctx.canvas.width - XGUTTER) * (chrLengths[chr] / totalLen) - XGUTTER;
            doScatter(ctx, study, chr, offset, xsize, ysize, chrLengths[chr]);
            offset += xsize + XGUTTER;
        }
    }

    function canvasToChr(a, b) {
        chrRange = [];
        var offset = XGUTTER;
        var aChr = 0;
        var bChr = 0;
        var gutters = (chrLengths.length + 1) * XGUTTER;
        var nt2px = (ctxi.canvas.width - gutters) / totalLen;
        var aPos, bPos;
        var chrNames = [];
        for (var chr in chrLengths) {
            chrNames.push(chr);
        }
        for (i = 0; i &lt; chrNames.length; i++) {
            var chr = chrNames[i];
            var chrXsize = nt2px * chrLengths[chr];
            if (a &gt;= offset - XGUTTER &amp;&amp; a &lt;= offset + chrXsize) {
                aChr = i;
                aPos = Math.floor(chrLengths[chr] * Math.max(a - offset, 0) / chrXsize);
            }
            if (b &gt;= offset &amp;&amp; b &lt;= offset + chrXsize + XGUTTER) {
                bChr = i;
                bPos = Math.ceil(chrLengths[chr] * Math.max(b - offset, 0) / chrXsize);
            }
            offset += chrXsize + XGUTTER;
        }
        if (aChr &lt;= bChr) {
            if (aChr === bChr) {
                chrRange[0] = [chrNames[aChr], aPos, bPos];
            } else if (aChr === bChr - 1) {
                chrRange[0] = [chrNames[aChr], aPos, chrLengths[chrNames[aChr]]];
                chrRange[1] = [chrNames[bChr], 0, bPos];
            } else {
                chrRange[0] = [chrNames[aChr], aPos, chrLengths[chrNames[aChr]]];
                for (i = 1; i &lt; bChr - aChr; i++) {
                    chrRange[i] = [chrNames[aChr + i], 0, chrLengths[chrNames[aChr + i]]];
                }
                chrRange[bChr - aChr] = [chrNames[bChr], 0, bPos];
            }
        }
    }

    function canvasToScore(a, b) {
        scoreA = globalMax * (ctxi.canvas.height - a) / ctxi.canvas.height;
        scoreB = globalMax * (ctxi.canvas.height - b) / ctxi.canvas.height;
    }

    function doScatter(ctx, study, chr, offset, xsize, ysize, chrLen) {
        var path = &quot;/gwas/&quot; + study + &quot;/scatter&quot; + &quot;?chr=&quot; + chr + &quot;&amp;b1=&quot; + Math.floor(xsize / sc) + &quot;&amp;b2=&quot; + Math.floor(ysize / sc) + &quot;&amp;x1=&quot; + chrLen + &quot;&amp;x2=&quot; + globalMax;
        $.getJSON(path, function (json) {
            if (! json) {
                return;
            }
            var xrange = chrLen;
            var yrange = globalMax;
            var xfactor = xsize / xrange;
            var yfactor = ysize / yrange;
            if (chr % 2 === 0) {
                ctx.fillStyle = &quot;darkorange&quot;;
                mincolor = [255, 165, 0];
                maxcolor = [255, 0, 0];
            } else {
                ctx.fillStyle = &quot;black&quot;;
                mincolor = [150, 150, 150];
                maxcolor = [0, 0, 0];
            }
            for (var i = 0; i &lt; json.data.length; i++) {
                var rect = json.data[i];
                if (rect.length == 3) {
                    // not a rectangle, just a point
                    var x = xfactor * rect[0] + offset;
                    var y = ysize - yfactor * rect[1];

                    if (colorByDensity) {
                        var ratio = rect[2] / json.max;
                        var r = mincolor[0] + Math.floor(ratio * (maxcolor[0] - mincolor[0]));
                        var g = mincolor[1] + Math.floor(ratio * (maxcolor[1] - mincolor[1]));
                        var b = mincolor[2] + Math.floor(ratio * (maxcolor[2] - mincolor[2]));

                        ctx.fillStyle = &quot;rgb(&quot; + r + &quot;,&quot; + g + &quot;,&quot; + b + &quot;)&quot;;
                    }

                    if (circles) {
                        ctx.beginPath();
                        ctx.arc(Math.floor(x), Math.floor(y), radius, 0, 2 * Math.PI, true);
                        ctx.closePath();
                        ctx.fill();
                    } else {
                        ctx.fillRect(Math.floor(x), Math.floor(y), sc, sc);
                    }
                } else {
                    var width = xfactor * (rect[1] - rect[0]);
                    var height = sc + yfactor * (rect[3] - rect[2]);
                    x = xfactor * rect[0] + offset;
                    y = ysize - height - yfactor * rect[2];
                    if (height &lt; sc) {
                        height = sc;
                    }
                    if (width &lt; sc) {
                        width = sc;
                    }
                    ctx.fillRect(Math.floor(x), Math.floor(y), Math.ceil(width), Math.ceil(height));
                }
            }
        });
    }


    function startDragEvent() {
        return function(ev) {
            if (ev.layerX || ev.layerX === 0) {
                ev._x = ev.layerX;
                ev._y = ev.layerY;
            } else if (ev.offsetX || ev.offsetX === 0) {
                ev._x = ev.offsetX;
                ev._y = ev.offsetY;
            }
            tool.started = true;
            tool.x = ev._x;
            tool.y = ev._y;
            ctxi.clearRect(0, 0, ctxi.canvas.width, ctxi.canvas.height);
            ctxi.strokeRect(tool.x, tool.y, 1, 1);
        };
    }

    function moveDragEvent() {
        return function(ev) {
            if (tool.started) {
                if (ev.layerX || ev.layerX === 0) {
                    ev._x = ev.layerX;
                    ev._y = ev.layerY;
                } else if (ev.offsetX || ev.offsetX === 0) {
                    ev._x = ev.offsetX;
                    ev._y = ev.offsetY;
                }
                var x = tool.x &lt; ev._x ? tool.x : ev._x;
                var y = tool.y &lt; ev._y ? tool.y : ev._y;
                var width = Math.abs(ev._x - tool.x + 1);
                var height = Math.abs(ev._y - tool.y + 1);
                ctxi.clearRect(0, 0, ctxi.canvas.width, ctxi.canvas.height);
                ctxi.fillRect(x, y, width, height);
                ctxi.strokeRect(x, y, width, height);
            }
        };
    }

    function releaseDragEvent() {
        return function(ev) {
            if (tool.started) {
                if (ev.layerX || ev.layerX === 0) {
                    ev._x = ev.layerX;
                    ev._y = ev.layerY;
                } else if (ev.offsetX || ev.offsetX === 0) {
                    ev._x = ev.offsetX;
                    ev._y = ev.offsetY;
                }
                var x1 = tool.x;
                var x2 = ev._x;
                var y1 = tool.y;
                var y2 = ev._y;
                if (tool.x &gt; ev._x) {
                    x1 = ev._x;
                    x2 = tool.x;
                }
                if (tool.y &gt; ev._y) {
                    y1 = ev._y;
                    y2 = tool.y;
                }
                // need to convert x, y pixels to intervals on chromosomes and scores
                canvasToChr(x1, x2);
                canvasToScore(y1, y2);
                var chrRangeString = JSON.stringify(chrRange);
                tool.started = false;
//                ctxi.clearRect(0, 0, ctxi.canvas.width, ctxi.canvas.height);
                console.log([scoreB, scoreA, chrRangeString]);
            }
        };
    }
    
    function build_where(json) {
        var where = json[0] + ' &lt;= score &lt;= ' + json[1] + ' and (';
        for (var i=0; i &lt; json[2].length; i++) {
            if (i&gt;0) {
                where += ' or ';
            }
            where += '( chr == \'' + json[2][i][0] + '\' and ' + json[2][i][1] + ' &lt;= pos &lt;= ' + json[2][i][2] + ')';
        }
        where += ')';
        return encodeURIComponent(where);
    }

    return Iris.Widget.extend({
        display: widget.display
    });
});</pre>
</body>
</html>
