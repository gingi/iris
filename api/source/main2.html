<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">require([
    'jquery',
    'backbone',
    'underscore',
    'renderers/manhattan',
    'util/progress',
    'util/viewport',
    'util/hud',
    'util/help',
    'g2p/dropdowns',
    'g2p/blurb',
    'g2p/genepad'],
    function (
        JQ, Backbone, _, ManhattanPlot, Progress, Viewport, HUD, Help,
        DropDowns, Blurb, GenePad
    ) {
  
    function dataAPI(path) { return &quot;/data&quot; + path; }

    var MANHATTAN_HEIGHT = &quot;300px&quot;;
    var PVALUE_THRESHOLD = 1;
    var MAX_GENES_PER_REQUEST = 100;
    var BP2PX = 25e4;
    
    var genesXHR;
    var hud;
    var dropdowns = new DropDowns(dataAPI);
    var router, genepad;

    // Vent: Event Aggregator
    var Vent = _.extend({}, Backbone.Events);

    // Models
    var Trait = Backbone.Model.extend({
        defaults: { name: &quot;&quot;, genome: &quot;&quot; },
        urlRoot: dataAPI(&quot;/trait&quot;),
        parse: function (json) {
            if (json[&quot;trait&quot;]) {
                this.name = json[&quot;trait&quot;][&quot;name&quot;];
                this.genome = json[&quot;trait&quot;][&quot;id&quot;].replace(/\.trait.*JQ/, '');
                this.experiment = this.parentId = json[&quot;trait&quot;][&quot;experiment&quot;];
            }
            return json;
        }
    });
    var SubViewModel = Backbone.Model.extend({
        parse: function (data) { this.set(data); }
    });
    var Network = SubViewModel.extend({
        url: dataAPI('/network/internal')
    });
    
    var ExpressionProfile = SubViewModel.extend({
        defaults: {
            terms: &quot;PO:0009005,PO:0009006,PO:0009010,PO:0009025,PO:0005352&quot;,
        },
        url: function () {
            var url = dataAPI(&quot;/query/expression&quot;);
            return url;
        },
        parse: function (json) {
            if (!json || !json.data) return;
            var matrix = [];
            var columns = [];
            var maxScore = 0;
            json.data.forEach(function (values, i) {
                for (var j = 0; j &lt; values.length; j++) {
                    var val = parseFloat(values[j]);
                    matrix.push([i, j, val]);
                    maxScore = Math.max(val, maxScore);
                }
            });
            SubViewModel.prototype.parse.call(this, {
                rows:     _.pluck(json.genes, &quot;name&quot;),
                columns:  _.pluck(json.terms, &quot;name&quot;),
                matrix:   matrix,
                maxScore: maxScore
            });
        }
    });
    var GeneFunctions = SubViewModel.extend({
        url: function () {
            return dataAPI('/query/gene-function');
        },
        parse: function (data) {
            var genes = [];
            for (var id in data.genes) {
                for (var i in data.genes[id].terms) {
                    genes.push([
                        data.genes[id].name,
                        data.terms[i].term,
                        data.terms[i].ec,
                        data.terms[i].desc,
                        data.genes[id].function
                    ]);
                }
            }
            SubViewModel.prototype.parse.call(this, {
                data: genes,
                columns: ['Name', 'GO Term', 'EC', 'Description', 'Function'],
                filter: ['EC']
            });
        },
    });
    var GOEnrichment = SubViewModel.extend({
        url: function () {
            return dataAPI('/query/go-enrichment');
        },
        parse: function (data) {
            var filtered = [];
            var threshold = data.length &lt; 50 
                ? PVALUE_THRESHOLD : PVALUE_THRESHOLD * 2;
            for (var i = 0; i &lt; data.length; i++) {
                var normalized = -Math.log(data[i].pvalue) / Math.LN10;
                if (normalized &gt;= threshold) {
                    filtered.push({
                        x: data[i].goID,
                        y: normalized,
                        title: data[i].goDesc.join(&quot;\n&quot;)
                    });
                }
            }
            SubViewModel.prototype.parse.call(this, filtered);
        },
    });
    
    var SubView = Backbone.View.extend({
        defaults: {
            require:      '',
            title:        'Blank',
            elementId:    '',
            renderParams: {},
            fetchParams:  {}
        },
        initialize: function (params) {
            _.bindAll(this, 'render');
            this.model.on('change', this.render);
            Vent.on('genes', this.fetchModel, this);
            var wrapper = JQ(&quot;&lt;div&gt;&quot;).addClass(&quot;col-md-4&quot;);
            JQ(&quot;#subviews&quot;).append(wrapper);
            this.viewport = new Viewport({
                parent: wrapper,
                height: 400,
                title: this.options.title,
                id: this.options.elementId,
                sortContainer: JQ(&quot;#subviews&quot;)
            });
            this.progress = new Progress({ element: this.viewport });
            this.progress.show();
        },
        render: function() {
            var self = this;
            require([self.options.require], function(Chart) {
                self.progress.dismiss();
                this.chart = new Chart(_.extend({
                    element: self.viewport
                }, self.options.renderParams));
                this.chart.setData(self.model.toJSON());
                this.chart.render();
                self.viewport.renderer(this.chart);
                if (typeof self.options.afterRender === 'function') {
                    self.options.afterRender.call(self, this.chart);
                }
            })
        },
        fetchModel: function (genes) {
            var self = this;
            if (genes === null || genes === &quot;&quot;) {
                self.viewport.append(
                    JQ(&quot;&lt;div&gt;&quot;).addClass(&quot;alert alert-block alert-info&quot;)
                        .text(&quot;Nothing to show!&quot;));
                this.progress.dismiss();
                return;
            }
            var data = { genes: genes };
            for (var prop in this.options.fetchParams) {
                data[prop] = this.options.fetchParams[prop];
            }
            if (typeof this.options.beforeFetch === 'function') {
                this.options.beforeFetch.call(self.model, data);
            }
            this.model.fetch({
                data: data,
                error: function (model, response) {
                    var message = JQ(&quot;&lt;span&gt;&quot;)
                        .text(&quot;Uhoh! Got bad vibes from the server&quot;)
                        .append(JQ(&quot;&lt;h5&gt;&quot;).text(&quot;The dirty details:&quot;))
                        .append(JQ(&quot;&lt;pre&gt;&quot;).addClass(&quot;mini&quot;)
                            .append(response.responseText)).html();
                    self.viewport.showError({ message: message });
                }
            });
        }
    });
    
    var ManhattanView = Backbone.View.extend({
        el: JQ(&quot;#datavis&quot;),
        makeRow: function (id) {
            var row = this.$el.find(&quot;#&quot; + id);
            if (!row.length) {
                row = JQ(&quot;&lt;div&gt;&quot;).attr(&quot;id&quot;, id);
                this.$el.append(row);
            }
            if (!row.hasClass('row')) row.addClass(&quot;row&quot;);
            return row;
        },
        initialize: function () {
            //Listeners
            _.bindAll(this, 'render');
            Vent.bind(&quot;selection&quot;, this.createSubViews, this);
            if (this.model) {
                this.model.on('change', this.render);
                this.model.on('error', this.errorHandler, this);
            }
            this.$el.empty();

            this.$el.css(&quot;position&quot;, &quot;relative&quot;)

            // Prepare transitions
            hud = new HUD({
                position: { top: 40, right: 10 },
                element: &quot;body&quot;,
                width: 150,
                height: 50,
                close: false,
                z: 500
            });
            
            hud.progress = new Progress({ element: hud, fade: false });
            this.manhattanContainer = this.makeRow(&quot;manhattan-row-container&quot;);
            this.subviewBar =         this.makeRow(&quot;subviews&quot;);
            this.$el.find(&quot;.alert&quot;).remove();
            this.progress = new Progress({ element: this.manhattanContainer });
            if (this.model) {
                this.progress.show();
            }
        },
        render: function () {
            var self = this;
            var $el = self.$el;
            var model = self.model;
            if (!model.get('variations') ||
                model.get('variations').length == 0) {
                self.errorHandler(model, { status: '404' });
                return;
            }
            self.progress.dismiss();
            var spanContainer = JQ(&quot;&lt;div&gt;&quot;).addClass(&quot;col-md-12&quot;);
            self.manhattanContainer.empty().append(spanContainer);
            var viewport = new Viewport({
                parent: spanContainer,
                height: MANHATTAN_HEIGHT,
                id: &quot;manhattan-vis&quot;,
                title: &quot;Manhattan Plot&quot;,
            });
            
            var vis = self.vis = new ManhattanPlot({ element: viewport });
            vis.setData({
                variations: model.get('variations'),
                contigs:    model.get('contigs'),
                maxscore:   model.get('maxscore')
            });
            vis.render();
            viewport.renderer(vis);
            viewport.addTool(JQ(&quot;&lt;a&gt;&quot;, { href: &quot;#&quot;, id: &quot;mnh-show-genes&quot; })
                .html(&quot;&lt;i class=\&quot;icon-eye-open\&quot;&gt;&lt;/i&gt; Show genes&quot;).click(
                    function () {
                        var link = JQ(this);
                        self.showGenes =
                            self.showGenes === null ? true : !self.showGenes;
                        if (self.showGenes) {
                            self.highlightGenes();
                            link.html(
                                &quot;&lt;i class=\&quot;icon-eye-close\&quot;&gt;&lt;/i&gt; Hide genes&quot;);
                        } else {
                            vis.unhighlight();
                            link.html(
                                &quot;&lt;i class=\&quot;icon-eye-open\&quot;&gt;&lt;/i&gt; Show genes&quot;);
                        }
                        return false;
                    }
                )
            );
            vis.on(&quot;selection&quot;, function (evt, scoreA, scoreB, ranges) {
                Vent.trigger(&quot;selection&quot;, [scoreA, scoreB, ranges]);
                if (genesXHR) {
                    // If a prior query is in progress
                    genesXHR.abort();
                    hud.empty();
                }
                var tbody = JQ(&quot;&lt;tbody&gt;&quot;);
                hud.empty();
                hud.show();
                setInterval(function () {
                    if (hud.is(&quot;:empty&quot;)) { hud.progress.show(); }
                }, 500);
                var pmin = Math.pow(10, -scoreA);
                var pmax = Math.pow(10, -scoreB);
                if (pmin &gt; pmax) {
                    var tmp = pmin; pmin = pmax; pmax = tmp;
                }
                genesXHR = JQ.ajax({
                    url: dataAPI('/trait/' + self.model.id + '/genes'),
                    dataType: 'json',
                    data: {
                        pmin: pmin,
                        pmax: pmax,
                        locations: ranges
                    }
                })
                .done(function () {
                    self.handleGeneSelection.apply(self, arguments)
                });
            });
            vis.on(&quot;pinpoint&quot;, function () { });
            return this;
        },
        highlightGenes: function () {
            var self = this;
            if (self.selectedGenes) {
                self.vis.highlight(
                    _.map(self.selectedGenes, function (g) {
                    return {
                        contig: g[2],
                        pos: g[3],
                        title: g[1]
                    }
                }));
            }
        },
        errorHandler: function (model, error) {
            var text = '';
            if (error.status == '404') {
                text = error.responseText ? 
                    JSON.parse(error.responseText).error : &quot;Not found&quot;
            } else {
                var details;
                try {
                    details = JSON.parse(error.responseText).error;
                } catch (err) {
                    details = error.responseText;
                }
                text = JQ(&quot;&lt;span&gt;&quot;)
                    .append(JQ(&quot;&lt;h3&gt;&quot;).text(&quot;Unexpected Error&quot;))
                    .append(JQ(&quot;&lt;p&gt;&quot;).html(&quot;Our apologies. Please &quot; +
                        &quot;&lt;a href=\&quot;mailto:shiran@cshl.edu\&quot;&gt;contact us&lt;/a&gt; &quot; +
                        &quot;with the following details if this problem persists.&quot;
                    ))
                    .append(JQ(&quot;&lt;pre&gt;&quot;).css(&quot;font-size&quot;, &quot;8pt&quot;).text([
                        &quot;TECHNICAL DETAILS&quot;,
                        &quot;=================&quot;,
                        &quot;Status:  &quot; +
                            error.statusText + &quot; (&quot; + error.status + &quot;)&quot;,
                        &quot;Error:   &quot; + details
                    ].join(&quot;\n&quot;)));
            }
            this.progress.dismiss();
            this.manhattanContainer.empty();
            this.subviewBar.empty();
            this.$el.append(JQ(&quot;&lt;div&gt;&quot;)
                .addClass(&quot;alert alert-warning&quot;).html(text));
        },
        handleGeneSelection: function (genes, status, jqXhr) {
            var self = this;
            var $p = JQ(&quot;&lt;p&gt;&quot;)
                .css(&quot;text-align&quot;,  &quot;center&quot;)
                .css(&quot;font-weight&quot;, &quot;bold&quot;)
            $p.text(genes.length &gt; 0
                ? genes.length + &quot; genes selected&quot; : &quot;No genes found&quot;);
            var geneIDs = _.pluck(genes, 0);
            self.selectedGenes = genes;
            if (self.showGenes) {
                self.highlightGenes();
            }
            hud.progress.dismiss();
            hud.append($p);
            if (jqXhr.status == 206) {
                hud.append(JQ(&quot;&lt;div&gt;&quot;).addClass(&quot;alert mini&quot;).html(
                    &quot;&lt;h3&gt;Warning!&lt;/h3&gt;&lt;p&gt;Not all genes are shown. &quot; +
                    &quot;The app can't handle more genes at this time. &quot; +
                    &quot;Please select a smaller window.&lt;/p&gt;&quot;
                ));
            }
            
            Vent.trigger(&quot;genes&quot;, geneIDs.join(&quot;,&quot;));
        },
        createSubViews: function () {
            this.subviewBar.empty();
            var network = new Network;
            var networkFetched = JQ.Deferred();
            var networkVis = null;
            var networkView = new SubView({
                model: network,
                require: 'renderers/network',
                elementId: 'network',
                title: 'Internal Network',
                renderParams: {
                    hud: JQ(&quot;#subinfobox&quot;),
                    dock: false
                },
                beforeFetch: function (data) {
                    data.nodes = data.genes;
                    delete data.genes;
                },
                afterRender: function (vis) {
                    networkFetched.resolve();
                    networkVis = vis;
                    vis.on('click-node', function (evt, node) {
                        var tbody = JQ(&quot;&lt;tbody&gt;&quot;);
                        function row(key, val) {
                            tbody.append(JQ(&quot;&lt;tr&gt;&quot;)
                                .append(JQ(&quot;&lt;th&gt;&quot;).text(key))
                                .append(JQ(&quot;&lt;td&gt;&quot;).text(val))
                            );
                        }
                        row(&quot;Name&quot;, node.name);
                        row(&quot;Type&quot;, node.type);
                        row(&quot;KBase ID&quot;, node.entityId);
                        row(&quot;Neighbors&quot;, vis.neighbors(node).length);
                        
                        networkView.hud.empty().append(JQ(&quot;&lt;table&gt;&quot;)
                            .addClass(&quot;table table-condensed&quot;)
                            .append(tbody));
                        networkView.hud.show();
                    });
                }
            });
            networkView.hud = new HUD({
                title: &quot;Network Node&quot;,
                position: { bottom: 50, left: 50 },
                element: &quot;#datavis&quot;,
                width: 300
            });
            
            
            var expressionModel = new ExpressionProfile;
            var expView = new SubView({
                model: expressionModel,
                require: 'renderers/heatmap',
                elementId: 'heatmap',
                title: 'Expression Profile',
                fetchParams: { terms: expressionModel.get('terms') }
            });

            var funcView = new SubView({
                model: new GeneFunctions,
                require: 'renderers/table',
                elementId: &quot;gene-table&quot;,
                title: &quot;Trait Genes&quot;,
                afterRender: function () {
                    JQ(&quot;#gene-table&quot;).on(&quot;filter&quot;, function (evt, tbl) {
                        // FIXME: Move functionality to renderer/table
                        if (networkVis) networkVis.unhighlightAll();
                        if (tbl.asDataSearch.length == 0 ||
                            tbl.asDataSearch.length == tbl.aoData.length) {
                            return;
                        }
                        var filtered = _.uniq(_.map(tbl.asDataSearch, function (t) {
                            return t.split(/\s+/)[0];
                        }));
                        if (filtered.length &gt; 0) {
                            networkFetched.then(function () {
                                filtered.forEach(function (geneName) {
                                    networkVis.highlight(geneName);
                                });
                            });
                        }
                    })
                }
            });
            
            var barchart = new SubView({
                model: new GOEnrichment,
                require: 'charts/bar',
                elementId: &quot;go-histogram&quot;,
                title: &quot;Gene Ontology Enrichment&quot;,
                renderParams: { yTitle: &quot;-log10 p&quot; }
            });
        }
    });
    
    function fetchGeneData(params) {
        var promises = [];
        function makeRequest(genes) {
            return JQ.ajax({
                url: params.url,
                dataType: 'json',
                data: { genes: genes.join(&quot;,&quot;) },
            });
        }
        for (var i = 0; i &lt; params.genes.length; i++) {
            promises.push(makeRequest(params.genes[i]));
        }
        return JQ.when.apply(JQ, promises).then(function () {
            var json;
            if (arguments.length == 0) {
                return null;
            }
            if (params.genes.length == 1) {
                // Single request, no merging necessary
                return arguments[0];
            }
            var args = _.map(arguments, function (arg) { return arg[0]; });
            if (_.isArray(args[0])) {
                json = [];
                args.forEach(function (arg) {
                    JQ.merge(json, arg);
                });
            } else {
                json = {};
                args.unshift(true, json);
                JQ.extend.apply(JQ, args);
            }
            return json;
        });
    }
    
    var Router = Backbone.Router.extend({
        routes: {
            &quot;trait/:traitId&quot;: &quot;show&quot;,
            &quot;genepad/:genes&quot;: &quot;genepad&quot;,
            &quot;:type/:id&quot;:      &quot;dropdownSelect&quot;,
            &quot;*action&quot;:        &quot;default&quot;
        },
        dropdownSelect: function (type, id) {
            dropdowns.listen(type, id);
            dropdowns.select(type, id);
        },
        show: function (traitId) {
            var trait = new Trait;
            trait.set({id: decodeURIComponent(traitId)});
            new ManhattanView({ model: trait });
            trait.fetch({
                data: { p: 30 },
                success: function (t) {
                    dropdowns.update('trait', traitId, t.parentId);
                    dropdowns.select('trait', traitId);
                }
            });
        },
        genepad: function (genes) {
            genepad.setGenes(genes);
        },
        default: function () {
            JQ(&quot;#datavis&quot;).empty();
            new Blurb(JQ(&quot;#datavis&quot;), router);
        },
    });

    var help = new Help({
        template: &quot;/templates/g2p-help.html&quot;,
        title: &quot;Using the Genotype Phenotype Workbench&quot;
    });
    
    genepad = new GenePad();
    genepad.collection.on(&quot;fetch&quot;, function () {
        var manhattanView = new ManhattanView();
        Vent.trigger(&quot;selection&quot;);
        manhattanView.handleGeneSelection(
            _.map(this.toJSON(), function (gene) {
                return [gene.id, gene.name];
            }), null, { status: 200 }
        );
    })
    
    router = new Router;
    Backbone.history.start();
    
    genepad.setRouter(router);
});</pre>
</body>
</html>
