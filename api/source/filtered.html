<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* jshint sub:true */
require([
    &quot;jquery&quot;, &quot;underscore&quot;, &quot;renderers/network&quot;, &quot;util/viewport&quot;,
    &quot;text!sample-data/network1.json&quot;, &quot;transformers/netindex&quot;,
    &quot;util/slider&quot;, &quot;text!templates/checkbox.html&quot;,
],
function (
    JQ, _, Network, Viewport, Example, NetIndex, Slider, CheckboxTemplate
) {
    &quot;use strict&quot;;
    Example = JSON.parse(Example);
    var minStrength = 0.7;
    var viewport = new Viewport({
        parent: &quot;#datavis&quot;,
        title: &quot;Network&quot;,
        maximize: true
    });
    viewport.css(&quot;min-height&quot;, &quot;600px&quot;);
    var datasetFilter = function () { return true; };
    var goLink = _.template(&quot;http://www.ebi.ac.uk/QuickGO/GTerm?id=&lt;%= id %&gt;&quot;);
    var network = new Network({
        element: viewport,
        dock: false,
        nodeLabel: { type: &quot;CLUSTER&quot; },
        infoOn: &quot;hover&quot;,
        edgeFilter: function (edge) {
            return edge.source != edge.target &amp;&amp;
                (edge.strength &gt;= minStrength ||
                    edge.source.type === &quot;CLUSTER&quot; ||
                    edge.target.type === &quot;CLUSTER&quot;) &amp;&amp;
                datasetFilter(edge);
        },
        nodeInfo: function (node, makeRow) {
            makeRow(&quot;Type&quot;, node.type);
            makeRow(&quot;KBase ID&quot;, link(node.entityId, &quot;#&quot;));
            if (node.type === &quot;GENE&quot; &amp;&amp; node.userAnnotations !== undefined) {
                var annotations = node.userAnnotations;
                if (annotations[&quot;external_id&quot;] !== undefined)
                    makeRow(&quot;External ID&quot;,
                        link(annotations[&quot;external_id&quot;], &quot;#&quot;));
                if (annotations[&quot;functions&quot;] !== undefined)
                    makeRow(&quot;Function&quot;, annotations[&quot;functions&quot;]);
                if (annotations.ontologies !== undefined) {
                    var goList = JQ(&quot;&lt;ul/&gt;&quot;);
                    _.each(_.keys(annotations.ontologies), function (item) {
                        goList.append(JQ(&quot;&lt;li/&gt;&quot;)
                            .append(link(item, goLink({ id: item }))));
                    });
                    makeRow(&quot;GO terms&quot;, goList);
                }
            }
        },
        searchTerms: function (node, indexMe) {
            indexMe(node.entityId);
            indexMe(node.kbid);
            if (node.userAnnotations !== undefined) {
                var annotations = node.userAnnotations;
                if (annotations[&quot;functions&quot;] !== undefined)
                    indexMe(annotations[&quot;functions&quot;]);
            }
        }
    });
    viewport.renderer(network);
    forceSlider(viewport, &quot;charge&quot;,   &quot;Node charge&quot;, JQ(&quot;&lt;i&gt;&quot;, {
        class: &quot;icon-magnet&quot;
    }), 5);
    forceSlider(viewport, &quot;distance&quot;, &quot;Edge distance&quot;, JQ(&quot;&lt;i&gt;&quot;, {
        class: &quot;icon-resize-horizontal&quot;
    }));
    forceSlider(viewport, &quot;strength&quot;, &quot;Edge strength&quot;, JQ(&quot;&lt;span&gt;&quot;, {
        class: &quot;glyphicon glyphicon-link&quot;
    }), 0.015);
    forceSlider(viewport, &quot;gravity&quot;,  &quot;Gravity&quot;, &quot;G&quot;, 0.012);
    var toolbox = viewport.toolbox();
    addSlider(toolbox);
    addSearch(toolbox);
    
    // var fetchData = NetIndex(Example);
    var fetchData = JQ.getJSON(&quot;/data/network/kbase/coex&quot;);
    
    JQ.when(fetchData).done(function (data) {
        try {
            network.setData(data);
        } catch (error) {
            require([&quot;text!templates/error-alert.html&quot;], function (template) {
                JQ(&quot;#container&quot;).prepend(_.template(template, error));
            });
        }
        network.render();
        addDatasetDropdown(toolbox, data);
        addClusterDropdown(toolbox, data);
    });
    
    function forceSlider(viewport, property, title, label, factor) {
        if (factor === undefined)
            factor = 1;
        viewport.addTool((new Slider({
            title: title,
            label: label,
            value: 0,
            min: -10,
            max: 10,
            step: 1,
            slide: function (value) {
                network.forceDelta(property, value * factor);
                network.update();
            }
        })).element());
    }
    
    function addSlider($container) {
        var slider = new Slider({
            label: JQ(&quot;&lt;i&gt;&quot;, { class: &quot;icon-adjust&quot; }),
            title: &quot;Minimum edge strength&quot;,
            min: 0,
            max: 1,
            step: 0.01,
            value: 0.8,
            slide: function (value) {
                minStrength = value;
                network.update();
            }
        });
        $container.prepend(JQ(&quot;&lt;div&gt;&quot;, { class: &quot;btn btn-default tool&quot; })
            .append(JQ(&quot;&lt;div&gt;&quot;, { class: &quot;btn-pad&quot; })
                .append(slider.element())
            )
        );
    }

    function addSearch($container) {
        var wrapper = JQ(&quot;&lt;div&gt;&quot;, { class: &quot;btn btn-default tool&quot; });
        wrapper
            .append(JQ(&quot;&lt;div&gt;&quot;, { class: &quot;btn-pad&quot; })
                .append(JQ(&quot;&lt;input/&gt;&quot;, {
                    id: &quot;network-search&quot;,
                    type: &quot;text&quot;,
                    class: &quot;input-xs&quot;
                })))
            .append(JQ(&quot;&lt;div/&gt;&quot;, { class: &quot;btn-pad&quot; })
                .append(JQ(&quot;&lt;i/&gt;&quot;, { class: &quot;icon-search&quot; })));
        $container.prepend(wrapper);
        JQ(&quot;#network-search&quot;).keyup(function () {
            network.updateSearch(JQ(this).val());
        });
    }

    function addClusterDropdown($container, data) {
        var list = JQ(&quot;&lt;fieldset&gt;&quot;);
        var menu = JQ(&quot;&lt;ul&gt;&quot;, { class: &quot;dropdown-menu&quot;, role: &quot;menu&quot; })
            .append(JQ(&quot;&lt;li&gt;&quot;).append(list));
        var allClusters = dropdownCheckbox(&quot;all&quot;, &quot;All clusters&quot;, true);
        var allCheckbox = allClusters.find(&quot;input&quot;);
        allClusters.css(&quot;background-color&quot;, &quot;#666&quot;).css(&quot;color&quot;, &quot;#fff&quot;);
        list.append(allClusters);
        var clusters = [];
        
        // A bit of a Schwartzian Transform to sort by neighbors
        _.map(
            _.filter(data.nodes, function (n) { return n.type === &quot;CLUSTER&quot;; }),
            function (node) {
                clusters.push({
                    node: node,
                    neighbors: network.neighbors(node).length
                });
            }
        );
        _.each(_.sortBy(clusters,
            function (entry) { return -entry.neighbors; }),
            function (entry) {
                var box = dropdownCheckbox(entry.node.id, &quot;&quot;, true);
                var labelDiv = JQ(&quot;&lt;div&gt;&quot;, { style: &quot;min-width:120px&quot; })
                .append(
                    JQ(&quot;&lt;span&gt;&quot;, { style: &quot;float: left&quot; })
                        .html(entry.node.entityId)
                ).append(
                    JQ(&quot;&lt;span&gt;&quot;, { style: &quot;float:right;color:#aaa&quot; })
                        .html(&quot;N:&quot; + entry.neighbors)
                );
                box.children(&quot;label&quot;).first().append(labelDiv);
                list.append(box);
            }
        );
        list.find(&quot;label&quot;).click(function (event) {
            event.preventDefault();
        });
        list.find(&quot;input[type='checkbox']&quot;).click(function (event) {
            // Prevent menu from closing on checkbox
            event.stopPropagation();
            var box = JQ(this);
            var id = box.val();
            var checked = box.prop(&quot;checked&quot;);
            var clSelect = &quot;input[type='checkbox'][value!='all']&quot;;
            if (id === &quot;all&quot;) {
                list.find(clSelect)
                    .prop(&quot;checked&quot;, checked)
                    .trigger(&quot;change&quot;);
            } else {
                if (list.find(clSelect + &quot;:not(:checked)&quot;).length === 0)
                    allCheckbox.prop(&quot;checked&quot;, true);
                else
                    allCheckbox.prop(&quot;checked&quot;, false);
                
            }
        }).change(function (event) {
            var id = JQ(this).val();
            var checked = JQ(this).prop(&quot;checked&quot;);
            if (id === &quot;all&quot;)
                return;
            var node = network.findNode(id);
            if (node === null) {
                require([&quot;text!templates/error-alert.html&quot;],
                function (template) {
                    JQ(&quot;#container&quot;).prepend(_.template(template, {
                        message: &quot;Could not find node &quot; + id
                    }));
                });
                return;
            }
            network.pause();
            if (checked) {
                unhideCluster(node);
            } else {
                hideCluster(node);
            }
            network.resume();
        });
        var button = JQ(&quot;&lt;div&gt;&quot;, {
            class: &quot;btn btn-default btn-sm dropdown-toggle&quot;,
            &quot;data-toggle&quot;: &quot;dropdown&quot;
        }).text(&quot;Clusters &quot;).append(JQ(&quot;&lt;span/&gt;&quot;, { class: &quot;caret&quot;}))
            .dropdown();
        $container.prepend(JQ(&quot;&lt;div&gt;&quot;, { class: &quot;btn-group tool&quot; })
            .append(button)
            .append(menu)
        );
    }
    
    function unhideCluster(cluster) {
        network.unhideNode(cluster);
        var neighbors = network.neighbors(cluster, null);
        _.each(neighbors, function (nPair) {
            console.log(&quot;neighbor&quot;, nPair)
            var node = nPair[0];
            if (node.type === 'GENE')
                network.unhideNode(node);
        });
    }

    function hideCluster(cluster) {
        var neighbors = network.neighbors(cluster);
        _.each(neighbors, function (nPair) {
            var node = nPair[0];
            if (node.type === 'GENE')
                network.hideNode(node);
        })
        network.hideNode(cluster);
    }

    function addDatasetDropdown($container, data) {
        var wrapper = JQ(&quot;&lt;div&gt;&quot;, { class: &quot;btn-group tool&quot; });
        var list = JQ(&quot;&lt;ul&gt;&quot;, { class: &quot;dropdown-menu&quot;, role: &quot;menu&quot; });
        list.append(dropdownLink(&quot;All data sets&quot;, &quot;&quot;, &quot;all&quot;));
        _.each(data.datasets, function (ds) {
            var dsStr = ds.id.replace(/^kb.*\.ws\/\//, &quot;&quot;);
            list.append(dropdownLink(dsStr, ds.description, ds.id));
        });
        list.find(&quot;a&quot;).on(&quot;click&quot;, function (event) {
            var id = JQ(this).data(&quot;value&quot;);
            list.find(&quot;li&quot;).removeClass(&quot;active&quot;);
            JQ(this).parent().addClass(&quot;active&quot;);
            if (id == &quot;all&quot;)
                datasetFilter = function () { return true; };
            else
                datasetFilter = function (edge) {
                    return edge.datasetId == id;
                };
            network.update();
        });
        var button = JQ(&quot;&lt;div/&gt;&quot;, {
            class: &quot;btn btn-default btn-sm dropdown-toggle&quot;,
            &quot;data-toggle&quot;: &quot;dropdown&quot;
        }).text(&quot;Data Set &quot;).append(JQ(&quot;&lt;span/&gt;&quot;, { class: &quot;caret&quot;}))
            .dropdown();
        wrapper
            .append(button)
            .append(list);
        $container.prepend(wrapper);
    }

    function dropdownLink(linkText, title, value) {
        return JQ(&quot;&lt;li&gt;&quot;)
            .append(JQ(&quot;&lt;a&gt;&quot;, {
                href: &quot;#&quot;,
                &quot;data-toggle&quot;: &quot;tooltip&quot;,
                &quot;data-container&quot;: &quot;body&quot;,
                &quot;title&quot;: title,
                &quot;data-original-title&quot;: title,
                &quot;data-value&quot;: value
            }).append(linkText));
    }
    function dropdownCheckbox(value, label, checked) {
        return JQ(&quot;&lt;div&gt;&quot;, { class: &quot;dropdown-menu-item&quot; })
            .append(_.template(CheckboxTemplate, {
                label: label,
                value: value,
                checked: checked
            }));
    }
    function link(content, href, attrs) {
        return JQ(&quot;&lt;a&gt;&quot;, _.extend({ href: href }, attrs)).html(content);
    }
});
</pre>
</body>
</html>
