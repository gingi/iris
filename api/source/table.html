<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">define([&quot;jquery&quot;, &quot;underscore&quot;, &quot;iris&quot;, &quot;datatables&quot;, &quot;columnfilter&quot;],
    function (JQ, _, iris) {
<span id='Table'>    /**
</span>     * @class Table
     * A table with sort, filter, and search
     * 
     * @extends Renderer
     */
    var Table = iris.Renderer.extend({
        defaults: {
            scrollY: 300,
            element: &quot;body&quot;,
            rowCallback: function () {}
        },
        initialize: function () {
            this.filterExclude = [];
        },
<span id='Table-method-setData'>        /**
</span>         * @method setData
         * Sets data. If the data is an {#link Array}, converts
         * @inheritdoc Renderer#setData
         */
        setData: function (data) {
            if (_.isArray(data)) {
                this.columns = _.first(data);
                this.data = _.rest(data);
            } else {
                this.columns = data.columns;
                this.data = data.data;
            }
            if (this.columns === undefined)
                this.columns = [];
            this.datafilter = this.datafilter || [];
            for (var i = 0; i &lt; this.columns.length; i++) {
                if (!_.contains(this.datafilter, this.columns[i])) {
                    this.filterExclude.push(i);
                }
            }
        },
<span id='Table-method-render'>        /**
</span>         * @method render
         * @inheritdoc Renderer#render
         */
        render: function (args) {
            var self = this;
            args = args ? _.clone(args) : {};
            var options = self.options;
            var $element = JQ(options.element);
            var elementOffset = $element.offset();
            var $table = JQ(&quot;&lt;table&gt;&quot;).addClass('table table-striped table-bordered');
            $element.empty().append($table);
            var cols = _.map(self.columns, function (d) {
                return { sTitle: d, type: &quot;string&quot; };
            });
            options.scrollY = Math.max($element.height()-100, options.scrollY);
            dataTableBehavior();
            $table.dataTable({
                sInfo: &quot;muted&quot;,
                aaData: self.data,
                aoColumns: cols,
                sPaginationType: &quot;bootstrap&quot;,
                bAutoWidth: true,
                sScrollY: options.scrollY,
                sScrollX: &quot;100%&quot;,
                bPaginate: false,
                oLanguage: {
                    sLengthMenu: &quot;_MENU_ per page&quot;,
                    sInfoThousands: &quot;,&quot;
                },
                fnRowCallback: function (tr, data) {
                    options.rowCallback.call(tr, data);
                },
                fnDrawCallback: args.success
            });
            var thead = $table.parent().prev().find(&quot;thead&quot;);
            var theadRow = thead.find(&quot;tr&quot;);
            var clone    = JQ(&quot;&lt;tr&gt;&quot;);
            theadRow.children().each(function () {
                clone.append(JQ(this).clone());
            });
            thead.append(clone);
            $table.columnFilter({
                sPlaceHolder: &quot;head:after&quot;,
                aoColumns: _.map(cols, function (d) {
                    return { type: &quot;text&quot;, bRegex: true }
                })
            });
            thead.find(&quot;input&quot;).addClass(&quot;form-control input-xs&quot;);

            thead.find(&quot;tr&quot;).filter(&quot;:last&quot;).children().each(function () {
                var attributes = this.attributes;
                var i = attributes.length;
                while (i--)
                    this.removeAttributeNode(attributes[i]);
            });

            $table.on(&quot;filter&quot;, function (event, tbl) {
                var filtered = _.map(tbl.aiDisplay, function (index) {
                    return self.data[index];
                });
                self.trigger(&quot;table:filter&quot;, [ filtered ]);
            });
        }
    });
    
    function dataTableBehavior() {
        /* Set the defaults for DataTables initialization */
        JQ.extend(true, JQ.fn.dataTable.defaults, {
            sDom: &quot;&lt;'dt-top'Wlfr&gt;&quot; +
                 &quot;&lt;'table-wrapper't&gt;&lt;'dt-bottom'ip&gt;&quot;,
            fnInitComplete: function (table) {
                JQ('.dataTables_length').find(&quot;select&quot;).addClass(&quot;col-md-2&quot;);
                JQ('.dataTables_filter').find(&quot;:input&quot;)
                    .addClass(&quot;input-small search-query&quot;)
                    .attr(&quot;placeholder&quot;, &quot;Search&quot;);
                JQ('.dataTables_length &gt; label').contents().filter(function() {
                    return this.nodeType != 1;
                }).wrap(&quot;&lt;span class='mini help-inline'&gt;&quot;);
            },
            sPaginationType: &quot;bootstrap&quot;,
            oLanguage: {
                sLengthMenu: &quot;_MENU_ records per page&quot;,
                sInfo: &quot;&lt;b&gt;_START_-_END_&lt;/b&gt; of &lt;b&gt;_TOTAL_&lt;/b&gt; entries&quot;,
                sSearch: &quot;&quot;
            }
        });


        /* Default class modification */
        JQ.extend(JQ.fn.dataTableExt.oStdClasses, {
            sWrapper: &quot;dataTables_wrapper form-inline&quot;,
            sInfo: &quot;mini muted dt-info&quot;
        });

        /* API method to get paging information */
        JQ.fn.dataTableExt.oApi.fnPagingInfo = function (opts) {
            return {
                iStart:         opts._iDisplayStart,
                iEnd:           opts.fnDisplayEnd(),
                iLength:        opts._iDisplayLength,
                iTotal:         opts.fnRecordsTotal(),
                iFilteredTotal: opts.fnRecordsDisplay(),
                iPage:
                    Math.ceil(opts._iDisplayStart / opts._iDisplayLength),
                iTotalPages:
                    Math.ceil(opts.fnRecordsDisplay() / opts._iDisplayLength)
            };
        };


        /* Bootstrap style pagination control */
        JQ.extend(JQ.fn.dataTableExt.oPagination, {
            bootstrap: {
                fnInit: function (opts, nPaging, fnDraw) {
                    var oLang = opts.oLanguage.oPaginate;
                    var fnClickHandler = function (e) {
                        e.preventDefault();
                        if (opts.oApi._fnPageChange(opts, e.data.action)) {
                            fnDraw(opts);
                        }
                    };
                    JQ(nPaging).addClass('pagination pagination-mini').append(_.template(
                        '&lt;ul&gt;' +
                            '&lt;li class=&quot;prev disabled&quot;&gt;' +
                            '&lt;a href=&quot;#&quot;&gt;&amp;larr;&lt;/a&gt;&lt;/li&gt;'+
                            '&lt;li class=&quot;next disabled&quot;&gt;'+
                            '&lt;a href=&quot;#&quot;&gt;&amp;rarr;&lt;/a&gt;&lt;/li&gt;'+
                        '&lt;/ul&gt;', { prev: oLang.sPrevious, next: oLang.sNext })
                    );
                    var els = JQ('a', nPaging);
                    JQ(els[0]).bind('click.DT',
                        { action: &quot;previous&quot; }, fnClickHandler);
                    JQ(els[1]).bind('click.DT',
                        { action: &quot;next&quot; }, fnClickHandler);
                },
                fnUpdate: function (opts, fnDraw) {
                    var iListLength = 5;
                    var oPaging = opts.oInstance.fnPagingInfo();
                    var an = opts.aanFeatures.p;
                    var i, j, sClass, iStart, iEnd, iHalf=Math.floor(iListLength/2);

                    if ( oPaging.iTotalPages &lt; iListLength) {
                        iStart = 1;
                        iEnd = oPaging.iTotalPages;
                    }
                    else if (oPaging.iPage &lt;= iHalf) {
                        iStart = 1;
                        iEnd = iListLength;
                    } else if (oPaging.iPage &gt;= (oPaging.iTotalPages-iHalf)) {
                        iStart = oPaging.iTotalPages - iListLength + 1;
                        iEnd = oPaging.iTotalPages;
                    } else {
                        iStart = oPaging.iPage - iHalf + 1;
                        iEnd = iStart + iListLength - 1;
                    }

                    for (i=0, iLen=an.length ; i&lt;iLen ; i++) {
                        // Remove the middle elements
                        JQ('li:gt(0)', an[i]).filter(':not(:last)').remove();

                        // Add the new list items and their event handlers
                        for (j=iStart ;j&lt;=iEnd ;j++) {
                            sClass = (j==oPaging.iPage+1) ? 'class=&quot;active&quot;' : '';
                            JQ('&lt;li '+sClass+'&gt;&lt;a href=&quot;#&quot;&gt;'+j+'&lt;/a&gt;&lt;/li&gt;')
                                .insertBefore(JQ('li:last', an[i])[0])
                                .bind('click', function (e) {
                                    e.preventDefault();
                                    opts._iDisplayStart = (parseInt(JQ('a', this).text(),10)-1) * oPaging.iLength;
                                    fnDraw(opts);
                                } );
                        }

                        // Add / remove disabled classes from the static elements
                        if (oPaging.iPage === 0) {
                            JQ('li:first', an[i]).addClass('disabled');
                        } else {
                            JQ('li:first', an[i]).removeClass('disabled');
                        }

                        if (oPaging.iPage === oPaging.iTotalPages-1 || oPaging.iTotalPages === 0) {
                            JQ('li:last', an[i]).addClass('disabled');
                        } else {
                            JQ('li:last', an[i]).removeClass('disabled');
                        }
                    }
                }
            }
        });


        /*
         * TableTools Bootstrap compatibility
         * Required TableTools 2.1+
         */
        if (JQ.fn.DataTable.TableTools) {
            // Set the classes that TableTools uses to something suitable for Bootstrap
            JQ.extend(true, JQ.fn.DataTable.TableTools.classes, {
                container: &quot;DTTT btn-group&quot;,
                buttons: {
                    normal: &quot;btn&quot;,
                    disabled: &quot;disabled&quot;
                },
                collection: {
                    container: &quot;DTTT_dropdown dropdown-menu&quot;,
                    buttons: {
                        normal: &quot;&quot;,
                        disabled: &quot;disabled&quot;
                    }
                },
                print: {
                    info: &quot;DTTT_print_info modal&quot;
                },
                select: {
                    row: &quot;active&quot;
                }
            });

            // Have the collection use a bootstrap compatible dropdown
            JQ.extend(true, JQ.fn.DataTable.TableTools.DEFAULTS.oTags, {
                collection: {
                    container: &quot;ul&quot;,
                    button: &quot;li&quot;,
                    liner: &quot;a&quot;
                }
            });
        }
    }
    
    iris.Renderer.register(&quot;Table&quot;, Table);
    return Table;
});</pre>
</body>
</html>
